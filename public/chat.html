<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assistente de Suporte Pro-Dados Plus</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f7fb; margin:0; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
    .header a { color:#667eea; text-decoration:none; }
    .card { background:#fff; border-radius: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.08); padding: 16px; }
    .messages { height: 60vh; overflow-y:auto; padding: 8px; background:#fafbff; border:1px solid #eceffd; border-radius: 12px; }
    .msg { display:flex; gap:8px; margin:12px 0; }
    .msg.user { justify-content: flex-end; }
    .msg.assistant { justify-content: flex-start; }
    .msg.user .bubble { background:#667eea; color:#fff; }
    .msg.assistant .bubble { background:#eef2ff; color:#333; }
    .bubble { padding:12px 14px; border-radius:12px; max-width: 80%; white-space: pre-wrap; }
    .input { display:flex; gap:8px; margin-top: 12px; }
    input[type="text"] { flex:1; padding:12px 14px; border-radius:12px; border:1px solid #dfe3f7; font-size:16px; }
    button { padding:12px 16px; border:none; border-radius:12px; background:#667eea; color:#fff; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .meta { font-size:12px; color:#666; margin-top:4px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#edf2ff; color:#374; font-size:12px; margin-right:6px; }
    .lock { position: fixed; inset:0; background: rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index: 9999; }
    .lock-card { background:#fff; padding:24px; border-radius:12px; box-shadow: 0 6px 20px rgba(0,0,0,.2); width: 360px; max-width: 92vw; }
    .lock-card h3 { margin-top:0; margin-bottom:12px; }
    .lock-card input { width:100%; padding:10px 12px; border:1px solid #dfe3f7; border-radius:10px; font-size:16px; display:block; }
    .lock-card button { width:100%; margin-top:10px; }

    /* Caixa com markdown formatado */
    .bubble.markdown { white-space: normal; background:#f7f8ff; }
    .bubble.markdown h1, .bubble.markdown h2, .bubble.markdown h3 { margin: .4em 0 .2em; }
    .bubble.markdown p { margin: .4em 0; }
    .bubble.markdown ul, .bubble.markdown ol { margin: .4em 0 .4em 1.2em; }
    .bubble.markdown code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
    .bubble.markdown pre { 
      background:#f8fafc; 
      color:#111827; 
      padding:12px 14px; 
      border-radius:12px; 
      overflow:auto; 
      border:1px solid #e5e7eb; 
      line-height:1.4; 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }
    .bubble.markdown pre code{ background:transparent; padding:0; }

    /* Acorde√£o para contexto */
    .context-accordion { 
      background:#f8fafc; 
      border:1px solid #e5e7eb; 
      border-radius:12px; 
      margin:8px 0; 
      overflow:hidden; 
    }
    .context-header { 
      background:#f1f5f9; 
      padding:12px 16px; 
      cursor:pointer; 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      font-weight:500; 
      color:#374151;
      transition: background-color 0.2s;
    }
    .context-header:hover { background:#e5e7eb; }
    .context-header .toggle { 
      font-size:18px; 
      transition: transform 0.2s; 
      color:#6b7280;
    }
    .context-header.expanded .toggle { transform: rotate(180deg); }
    .context-content { 
      max-height:0; 
      overflow:hidden; 
      transition: max-height 0.3s ease-out; 
      background:#ffffff;
    }
    .context-content.expanded { 
      max-height:1000px; 
      padding:16px; 
      border-top:1px solid #e5e7eb;
      overflow-y: auto;
      max-height: 400px;
    }
    .context-item { 
      background:#f9fafb; 
      border:1px solid #e5e7eb; 
      border-radius:8px; 
      padding:12px; 
      margin:8px 0; 
    }
    .context-item h4 { 
      margin:0 0 8px; 
      color:#374151; 
      font-size:14px; 
      font-weight:600; 
    }
    .context-item p { 
      margin:4px 0; 
      color:#6b7280; 
      font-size:13px; 
      line-height:1.4; 
    }
    .context-score { 
      display:inline-block; 
      background:#dbeafe; 
      color:#1e40af; 
      padding:2px 8px; 
      border-radius:12px; 
      font-size:11px; 
      font-weight:500; 
      margin-bottom:8px; 
    }

    .spinner { display:none; width:14px; height:14px; border:2px solid rgba(255,255,255,.6); border-top-color:#fff; border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #sendBtn.loading .spinner { display:inline-block; }
  </style>
  <!-- libs para renderizar markdown com sanitiza√ß√£o -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  </head>
  <body>
  <div class="container">
    <div class="header">
      <h2>ü§ñ Assistente de Suporte Pro-Dados Plus</h2>
      <a href="/">‚Üê Voltar</a>
    </div>

    <div class="card">
      <div id="messages" class="messages"></div>
      <div class="input">
        <input id="question" type="text" placeholder="Digite sua pergunta de suporte..." />
        <button id="sendBtn" onclick="send()"><span class="btn-label">Enviar</span><span class="spinner" aria-hidden="true"></span></button>
      </div>
      <div class="meta">
        Consulta topK (max 30): <input id="topK" type="number" min="1" max="100" value="10" style="width:60px;"> | 
        <label style="margin-left:6px;">
          <input type="checkbox" id="showContext" checked> Mostrar contexto utilizado
        </label>
      </div>
    </div>
  </div>

  <div id="lock" class="lock">
    <div class="lock-card">
      <h3>Digite a senha para acessar</h3>
      <input id="pwd" type="password" placeholder="Senha" />
      <button onclick="unlock()">Entrar</button>
      <div id="lockError" style="color:#c62828; font-size:13px; margin-top:8px; display:none;">Senha incorreta.</div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const questionEl = document.getElementById('question');
    const sendBtn = document.getElementById('sendBtn');
    const lockEl = document.getElementById('lock');
    const pwdEl = document.getElementById('pwd');
    const lockErr = document.getElementById('lockError');

    function appendMessage(role, text) {
      const row = document.createElement('div');
      row.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function appendAssistantMarkdown(md) {
      const row = document.createElement('div');
      row.className = 'msg assistant';
      const bubble = document.createElement('div');
      bubble.className = 'bubble markdown';
      try {
        const html = marked.parse(md || '');
        bubble.innerHTML = DOMPurify.sanitize(html);
      } catch (e) {
        bubble.textContent = md || '';
      }
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function appendContext(matches) {
      if (!matches || !matches.length) return;
      
      const row = document.createElement('div');
      row.className = 'msg assistant';
      
      const accordion = document.createElement('div');
      accordion.className = 'context-accordion';
      
      const header = document.createElement('div');
      header.className = 'context-header';
      header.innerHTML = `
        <span>üìö Contexto utilizado (top ${matches.length})</span>
        <span class="toggle">‚ñº</span>
      `;
      
      const content = document.createElement('div');
      content.className = 'context-content';
      
      matches.forEach((m, i) => {
        const md = m.metadata || {};
        const item = document.createElement('div');
        item.className = 'context-item';
        
        const score = document.createElement('div');
        score.className = 'context-score';
        score.textContent = `Score: ${Number(m.score).toFixed(3)}`;
        
        const title = document.createElement('h4');
        title.textContent = `Resultado #${i + 1}`;
        
        const details = document.createElement('div');
        if (md.titulo) details.innerHTML += `<p><strong>T√≠tulo:</strong> ${md.titulo}</p>`;
        if (md.problema) details.innerHTML += `<p><strong>Problema:</strong> ${md.problema}</p>`;
        if (md.solucao) details.innerHTML += `<p><strong>Solu√ß√£o:</strong> ${md.solucao}</p>`;
        if (md.nomeCli) details.innerHTML += `<p><strong>Cliente:</strong> ${md.nomeCli}</p>`;
        if (md.Tags) details.innerHTML += `<p><strong>Tags:</strong> ${md.Tags}</p>`;
        if (m.id) details.innerHTML += `<p><strong>ID:</strong> ${m.id}</p>`;
        
        item.appendChild(score);
        item.appendChild(title);
        item.appendChild(details);
        content.appendChild(item);
      });
      
      accordion.appendChild(header);
      accordion.appendChild(content);
      
      // Toggle do acorde√£o
      header.addEventListener('click', () => {
        const isExpanded = header.classList.contains('expanded');
        if (isExpanded) {
          header.classList.remove('expanded');
          content.classList.remove('expanded');
        } else {
          header.classList.add('expanded');
          content.classList.add('expanded');
        }
      });
      
      row.appendChild(accordion);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function send() {
      const question = questionEl.value.trim();
      const topK = parseInt(document.getElementById('topK').value || '5', 10);
      if (!question) return;
      questionEl.value = '';
      appendMessage('user', question);
      sendBtn.disabled = true;
      sendBtn.classList.add('loading');

      try {
        const endpoint = location.hostname === 'localhost' || location.hostname === '127.0.0.1' ? '/chat' : '/api/chat';
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-chat-password': window.__CHAT_PWD || '' },
          body: JSON.stringify({ question, topK })
        });
        const out = await res.json();
        sendBtn.disabled = false;
        sendBtn.classList.remove('loading');
        if (!res.ok) {
          appendMessage('assistant', 'Erro: ' + (out.error || 'Falha ao consultar.'));
          return;
        }
        if (document.getElementById('showContext').checked) {
          if (Array.isArray(out.matches) && out.matches.length > 0) {
            appendContext(out.matches);
          } else {
            appendMessage('assistant', 'Nenhum contexto retornado pelo banco vetorial.');
          }
        }
        appendAssistantMarkdown(out.answer || '(sem resposta)');
      } catch (err) {
        sendBtn.disabled = false;
        sendBtn.classList.remove('loading');
        appendMessage('assistant', 'Erro ao enviar a pergunta.');
      }
    }

    questionEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Mensagem inicial
    appendMessage('assistant', 'Ol√°! Sou seu assistente de suporte do Plus. Pergunte algo como: "Plus n√£o puxa a loja ao fazer login, o que verificar?"');

    function unlock() {
      const v = (pwdEl.value || '').trim();
      if (v === '120996') {
        window.__CHAT_PWD = v;
        lockEl.style.display = 'none';
        questionEl.focus();
      } else {
        lockErr.style.display = 'block';
      }
    }
    pwdEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') unlock();
    });
  </script>
  </body>
  </html>

